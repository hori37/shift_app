<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カレンダー</title>
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

  <!-- Bootstrapは、HTML・CSS・JavaScriptで構成されたフレームワーク -->
  <!-- Bootstrap 見た目を整えるCSS-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap モーダルなどを動かすJS（モーダルは、画面全体に重ねて表示されるポップアップウィンドウ）-->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
  body {
    color: black;
  }
  #calendar {
    color: black;
  }

  /* カレンダーのヘッダー */
  .fc-toolbar-title {
    color: black !important;
  }

  /* 曜日 */
  .fc-col-header-cell-cushion {
    color: black !important;
  }

  /* 日付 */
  .fc-daygrid-day-number {
    color: black !important;
  }

  /* 予定タイトル */
  /* .fc-event-title {
    color: black !important;
  } */

  .fc-event.normal-event,.fc-event.normal-event .fc-event-title,
.fc-event.normal-event .fc-event-time {
  background-color: #fff;
  border-color: black;
  color: #000;
}

  /* 日曜の背景色 */
  .fc-day.sunday,.fc-day.holiday {
  background-color: #ffecec;
  }

  /* 土曜の背景色 */
  .fc-day.saturday {
  background-color: #e6f0ff;
  }

  .fc-timegrid-event.shift-day {
  background-color: #4DB6AC !important;
  color: #FFFFFF !important;
}
.fc-timegrid-event.shift-night {
  background-color: #1E88E5 !important;
  color: #FFFFFF !important;
}
.fc-timegrid-event.shift-duty {
  background-color: #E57373 !important;
  color: #FFFFFF !important;
}

 /* シフト共通：背景色と文字色は維持、枠線なし */
.fc-event.shift-day,.fc-event.shift-day .fc-event-title,
.fc-event.shift-day .fc-event-time {
  background-color: #4db6a4;  /* 濃いグリーン */
  color: #FFFFFF !important;
  border-radius: 4px;
  font-weight: bold;
}

.fc-event.shift-night,.fc-event.shift-night .fc-event-title,
.fc-event.shift-night .fc-event-time {
  background-color: #1E88E5;  /* 濃いブルー */
  color: #FFFFFF !important;
  border-radius: 4px;
  font-weight: bold;
}

.fc-event.shift-duty,.fc-event.shift-duty .fc-event-title,
.fc-event.shift-duty .fc-event-time {
  background-color: #e57373;  /* 濃いレッド */
  color: #FFFFFF !important;
  border-radius: 4px;
  font-weight: bold;
}

/* 選択日を目立たせる */
#selectedDateLabel {
  font-size: 1.1em;
  background-color: #f0f0f0;
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 10px;
}

#shiftButtons button {
  margin: 0 8px;
  padding: 10px 20px;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

/* 日勤ボタン */
#shiftButtons button[data-shift="日勤"] {
  background-color: #C5E1A5;
  color: #33691E;
}

/* 夜勤ボタン  */
#shiftButtons button[data-shift="夜勤"] {
  background-color: #81D4FA;
  color: #01579B;
}

/* 当直ボタン */
#shiftButtons button[data-shift="当直"] {
  background-color: #FFCDD2;
  color: #B71C1C;
}

/* ホバー */
.fc-event:hover {
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  border: 1px solid #666;
}

/* 日付セル */
.selected-date {
  outline: 2px solid #42a5f5;
  background-color: #e3f2fd;
  border-radius: 4px;
}

/* 追加した勤務ボタン */
#customShiftButtons button {
  margin: 0 8px;
  padding: 10px 20px;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  color: #FFFFFF !important;
  background-color: #4DB6AC !important; /* デフォルト色、JSで上書きされる */
}

</style>

</head>
<body>  
  <div id='calendar'></div>

<!-- モーダルフォーム（予定入力用） -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- モーダルのヘッダー -->
      <div class="modal-header">
        <h5 class="modal-title" id="eventModalLabel">予定を登録</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
      </div>


      <!-- モーダルの本文（フォーム） -->
      <div class="modal-body">
        <form id="eventForm">
          <input type="hidden" id="eventId">

          <!-- モード切り替えタブ -->
          <div class="btn-group w-100 mb-3" role="group">
            <button type="button" class="btn btn-outline-primary active" id="modeSchedule">予定登録</button>
            <button type="button" class="btn btn-outline-success" id="modeShift">シフト登録</button>
          </div>


          <!-- 選択日表示（シフト登録モードで表示） -->
          <div id="selectedDateLabel" class="mb-3" style="display:none;">
            <strong>選択日：</strong> <span id="selectedDateText"></span>
          </div>

          <div id="shiftButtons" style="display: none;">
            <button data-shift="日勤">日勤</button>
            <button data-shift="夜勤">夜勤</button>
            <button data-shift="当直">当直</button>
          </div>

          <!-- タイトルと時間入力（シフト登録モードで表示） -->
         <div class="mb-3">
           <label for="eventTitle" class="form-label">タイトル</label>
           <input type="text" class="form-control" id="eventTitle" required>
          </div>
          <div class="mb-3">
           <label for="eventStart" class="form-label">開始時間</label>
           <input type="datetime-local" class="form-control" id="eventStart" required>
         </div>
          <div class="mb-3">
           <label for="eventEnd" class="form-label">終了時間</label>
            <input type="datetime-local" class="form-control" id="eventEnd" required>
          </div>
          <div class="mb-3">
            <label for="eventNote" class="form-label">メモ</label>
            <textarea class="form-control" id="eventNote" rows="2" placeholder="場所・持ち物・補足など自由に記入"></textarea>
          </div>
          <div class="mb-3">
            <label for="eventColor" class="form-label">表示色</label>
            <input type="color" class="form-control form-control-color" id="eventColor" value="#66bb6a">
          </div>

          <!-- 勤務タイプ追加欄 -->
          <div class="mb-3">
            <label class="form-label">新しい勤務タイプを追加</label>
            <div class="d-flex gap-2">
              <input type="text" id="customShiftName" class="form-control" placeholder="勤務名">
              <input type="color" id="customShiftColor" class="form-control form-control-color" value="#4DB6AC">
              <button type="button" class="btn btn-outline-primary" id="addCustomShift">追加</button>
            </div>
          </div>

          <!-- 追加された勤務タイプボタンを表示するエリア -->
          <div id="customShiftButtons" class="mb-3 d-flex flex-wrap gap-2">
            {% for shift in shift_types %}
              <button type="button"
                      class="btn"
                      style="background-color: {{ shift.color }}; color: {{ shift.text_color }};"
                      data-shift="{{ shift.name }}">
                {{ shift.name }}
              </button>
            {% endfor %}
          </div>
        </form>
      </div>

      <!-- モーダルのフッター（ボタン） -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-danger" id="deleteEvent">削除</button>
        <button type="button" class="btn btn-primary" id="saveEvent">保存</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const calendarEl = document.getElementById("calendar");

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    locale: "ja",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,timeGridWeek,timeGridDay"
    },
    eventSources: [
    {url: "/api/events"},
    {url: "/api/holidays"}
    ],
    eventClassNames: function(arg) {
    return arg.event.classNames;
  },


    dayCellClassNames: function(arg) {
      const day = arg.date.getDay();
      if (day === 0) return ["sunday"];   // 日曜
      if (day === 6) return ["saturday"]; // 土曜
      return [];
    },

    eventClick: function(info) {
      const event = info.event;
      document.getElementById("eventId").value = event.id;
      document.getElementById("eventTitle").value = event.title;
      document.getElementById("eventStart").value = event.start.toISOString().slice(0, 16);
      document.getElementById("eventEnd").value = event.end ? event.end.toISOString().slice(0, 16) : "";
      const modal = new bootstrap.Modal(document.getElementById("eventModal"));
      modal.show();
    },

    dateClick: function(info) {
      if (selectedCell) {
        selectedCell.classList.remove("selected-date");
      }
      selectedCell = info.dayEl;
      selectedCell.classList.add("selected-date");


      const dateStr = info.dateStr;
      document.getElementById("eventTitle").value = "";
      document.getElementById("eventStart").value = info.dateStr + "T09:00";
      document.getElementById("eventEnd").value = info.dateStr + "T10:00";
      document.getElementById("eventId").value = "";

      // 日付表示用ラベルにセット
      document.getElementById("selectedDateText").textContent = dateStr;

      // 初期モードは予定登録
      document.getElementById("modeShift").click();

      const modal = new bootstrap.Modal(document.getElementById("eventModal"));
      modal.show();
    },

    eventDidMount: function(info) {
      const note = info.event.extendedProps.note || "";
      const start = info.event.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const end = info.event.end ? info.event.end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "";
      const tooltip = `${info.event.title}\n${start}〜${end}\n${note}`;
      info.el.setAttribute("title", tooltip);
    }
  });

  calendar.render();

  let selectedCell = null;

  document.getElementById("addCustomShift").addEventListener("click", () => {
    const name = document.getElementById("customShiftName").value.trim();
    const color = document.getElementById("customShiftColor").value;

    if (!name || !color) {
      alert("勤務名と色を入力してください");
      return;
    }

    fetch("/add_shift_type", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ name, color })
    }).then(response => {
      if (!response.ok) {
        alert("追加に失敗しました");
        return;
      }
       return response.json();
      }).then(data => {
      // 勤務タイプボタンを追加
      const button = document.createElement("button");
      button.textContent = data.name;
      button.className = "btn";
      button.style.setProperty("color", data.text_color, "important");
      button.style.setProperty("background-color", data.color, "important");
      button.setAttribute("data-shift", data.name);

      // クリック時の登録処理
      button.onclick = () => {
        const dateStr = document.getElementById("eventStart").value.slice(0, 10);
        const start = dateStr + "T09:00";
        const end = dateStr + "T17:00";
        const note = document.getElementById("eventNote").value;

        fetch("/api/events", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: data.name,
            start: start,
            end: end,
            allDay: false,
            note: note,
            color: data.color

          })
        }).then(() => {
         calendar.refetchEvents();
       });
      };
        // 表示エリアにボタン追加
        document.getElementById("customShiftButtons").appendChild(button);

        // 入力欄をクリア
        document.getElementById("customShiftName").value = "";
        document.getElementById("customShiftColor").value = "#4DB6AC";
    });
  });

  function getShiftClass(shift) {
    if (shift === "日勤") return "shift-day";
    if (shift === "夜勤") return "shift-night";
    if (shift === "当直") return "shift-duty";
    return "normal-event";
  }

  // DOM要素の取得（モーダル切り替えロジックを追加）
  const modeScheduleBtn = document.getElementById("modeSchedule");
  const modeShiftBtn = document.getElementById("modeShift");
  const titleGroup = document.getElementById("eventTitle").parentElement;
  const startGroup = document.getElementById("eventStart").parentElement;
  const endGroup = document.getElementById("eventEnd").parentElement;
  const saveBtn = document.getElementById("saveEvent");
  const modalTitle = document.getElementById("eventModalLabel");
  const selectedDateLabel = document.getElementById("selectedDateLabel");
  const selectedDateText = document.getElementById("selectedDateText");
  const shiftButtons = document.getElementById("shiftButtons");
  const note = document.getElementById("eventNote").value;

  const colorGroup = document.getElementById("eventColor").closest(".mb-3");

  const scheduleInputs = document.createElement("div");
  scheduleInputs.id = "scheduleInputs";
  titleGroup.before(scheduleInputs);
  scheduleInputs.appendChild(titleGroup);
  scheduleInputs.appendChild(startGroup);
  scheduleInputs.appendChild(endGroup);

  // モード切り替え
  modeScheduleBtn.addEventListener("click", () => {
    isShiftMode = false;
    modeScheduleBtn.classList.add("active");
    modeShiftBtn.classList.remove("active");
    modalTitle.textContent = "予定を登録";
    scheduleInputs.style.display = "block";
    saveBtn.style.display = "inline-block";
    selectedDateLabel.style.display = "none";
    shiftButtons.style.display = "none"; // 非表示
    colorGroup.style.display = "block"; // 表示
  });

  modeShiftBtn.addEventListener("click", () => {
    isShiftMode = true;
    modeShiftBtn.classList.add("active");
    modeScheduleBtn.classList.remove("active");
    modalTitle.textContent = "シフトを登録";
    scheduleInputs.style.display = "none";
    saveBtn.style.display = "none";
    selectedDateLabel.style.display = "block";
    shiftButtons.style.display = "flex"; // 表示
    colorGroup.style.display = "none"; // 非表示

  });

  document.querySelectorAll("#shiftButtons button").forEach(button => {
  button.addEventListener("click", function () {
    const shift = this.getAttribute("data-shift");
    const startInput = document.getElementById("eventStart");
    const endInput = document.getElementById("eventEnd");
    const dateStr = startInput.value.slice(0, 10); // "YYYY-MM-DD"

    let start = "", end = "";
    if (shift === "日勤") {
      start = dateStr + "T08:00";
      end = dateStr + "T17:00";
    } else if (shift === "夜勤") {
      start = dateStr + "T16:00";
      end = dateStr + "T23:59";
    } else if (shift === "当直") {
      start = dateStr + "T22:00";
      end = dateStr + "T23:59";
    }

    // 即保存処理
    fetch("/api/events", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title: shift,
        start: start,
        end: end,
        allDay: false,
      })
    }).then(response => {
      if (!response.ok) {
        alert("保存に失敗しました");
        return;
      }

      calendar.refetchEvents();

      // 次の日に切り替え
      const nextDate = new Date(dateStr);
      nextDate.setDate(nextDate.getDate() + 1);
      const nextDateStr = nextDate.toISOString().slice(0, 10);

      startInput.value = nextDateStr + "T09:00";
      endInput.value = nextDateStr + "T10:00";
      document.getElementById("eventTitle").value = "";
      document.getElementById("eventId").value = "";
      document.getElementById("selectedDateText").textContent = nextDateStr;
      document.getElementById("eventNote").value = event.extendedProps.note || "";
    });
  });

  // モード切り替え用フラグ
  let isShiftMode = false;

  document.getElementById("saveEvent").addEventListener("click", function () {
    const id = document.getElementById("eventId").value;
    const title = document.getElementById("eventTitle").value;
    const start = document.getElementById("eventStart").value;
    const end = document.getElementById("eventEnd").value;
    const color = isShiftMode ? null : document.getElementById("eventColor").value;

    console.log("保存クリック:", { id, title, start, end });

    if (title && start && end) {
      const url = id ? "/api/update_event" : "/api/add_event";

      const allDay = isShiftMode; // シフトモードなら true、予定モードなら false

      fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, title, start, end, allDay,note,color })
      })
      .then(response => response.json())
      .then(data => {
        console.log("保存成功:", data);
        calendar.refetchEvents();

        if (isShiftMode) {
          const currentStart = new Date(start);
          const nextDate = new Date(currentStart);
          nextDate.setDate(currentStart.getDate() + 1);
          const nextDateStr = nextDate.toISOString().slice(0, 10);

          if (title === "日勤") {
            document.getElementById("eventStart").value = nextDateStr + "T08:00";
            document.getElementById("eventEnd").value = nextDateStr + "T17:00";
          } else if (title === "夜勤") {
            document.getElementById("eventStart").value = nextDateStr + "T17:00";
            document.getElementById("eventEnd").value = nextDateStr + "T23:59"; 
          } else if (title === "当直") {
              document.getElementById("eventStart").value = nextDateStr + "T22:00";
              document.getElementById("eventEnd").value = nextDateStr + "T23:59"; 
          }

          document.getElementById("eventId").value = "";
        } else {
          const modal = bootstrap.Modal.getInstance(document.getElementById("eventModal"));
          modal.hide();
        }

      })
  }
});


    document.getElementById("deleteEvent").addEventListener("click", function () {
      const id = document.getElementById("eventId").value;
      console.log("削除対象クリック:", id);

      if (id) {
        fetch("/api/delete_event", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        })
        .then(response => response.json())
        .then(data => {
          console.log("削除成功:", data); // デバッグ用
          calendar.setOption("events", "/api/events?" + new Date().getTime()); //キャッシュ回避
          calendar.refetchEvents();
          const modal = bootstrap.Modal.getInstance(document.getElementById("eventModal"));
          modal.hide();
        })
        .catch(error => {
          console.error("削除エラー:", error);
          alert("削除に失敗しました。サーバー側のURLやIDを確認してください。");
        });
      } else {
        alert("削除対象のIDがありません。");
      }
    });
  });
});
</script>
</body>
</html>