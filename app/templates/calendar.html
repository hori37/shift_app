<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カレンダー</title>
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

  <!-- Bootstrapは、HTML・CSS・JavaScriptで構成されたフレームワーク -->
  <!-- Bootstrap 見た目を整えるCSS-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap モーダルなどを動かすJS（モーダルは、画面全体に重ねて表示されるポップアップウィンドウ）-->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
  body {
    color: black;
  }
  #calendar {
    color: black;
  }

  /* カレンダーのヘッダー */
  .fc-toolbar-title {
    color: black !important;
  }

  /* 曜日 */
  .fc-col-header-cell-cushion {
    color: black !important;
  }

  /* 日付 */
  .fc-daygrid-day-number {
    color: black !important;
  }

  /* 予定タイトル */
  .fc-event-title {
    color: black !important;
  }

  /* 予定の背景色 */
  .fc-event {
    background-color: white !important;
    border-color: black !important;
    color: black !important;
  }

  /* 日曜の背景色 */
  .fc-day.sunday {
  background-color: #ffecec;
  }

  /* 土曜の背景色 */
  .fc-day.saturday {
  background-color: #e6f0ff;
  }
</style>

</head>
<body>
  <h1>Calendar</h1>
  <div id='calendar'></div>

<!-- モーダルフォーム（予定入力用） -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- モーダルのヘッダー -->
      <div class="modal-header">
        <h5 class="modal-title" id="eventModalLabel">予定を登録</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
      </div>

      <!-- モーダルの本文（フォーム） -->
      <div class="modal-body">
        <form id="eventForm">
          <input type="hidden" id="eventId">

          <!-- モード切り替えボタン -->
          <div class="btn-group mb-3" role="group">
            <button type="button" class="btn btn-outline-primary" id="modeSchedule">予定登録</button>
            <button type="button" class="btn btn-outline-success" id="modeShift">シフト登録</button>
          </div>

          <!-- 勤務区分ボタン（シフト登録モードで表示） -->
          <div id="shiftButtons" class="d-flex gap-2 mb-3" style="display:none;">
            <button type="button" class="btn btn-sm btn-outline-info" data-shift="日勤">日勤</button>
            <button type="button" class="btn btn-sm btn-outline-warning" data-shift="夜勤">夜勤</button>
            <button type="button" class="btn btn-sm btn-outline-danger" data-shift="当直">当直</button>
          </div>

          <!-- タイトルと時間入力 -->
         <div class="mb-3">
           <label for="eventTitle" class="form-label">タイトル</label>
           <input type="text" class="form-control" id="eventTitle" required>
          </div>
          <div class="mb-3">
           <label for="eventStart" class="form-label">開始時間</label>
           <input type="datetime-local" class="form-control" id="eventStart" required>
         </div>
          <div class="mb-3">
           <label for="eventEnd" class="form-label">終了時間</label>
            <input type="datetime-local" class="form-control" id="eventEnd" required>
          </div>
        </form>
      </div>

      <!-- モーダルのフッター（ボタン） -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-danger" id="deleteEvent">削除</button>
        <button type="button" class="btn btn-primary" id="saveEvent">保存</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const calendarEl = document.getElementById("calendar");

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    locale: "ja",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,timeGridWeek,timeGridDay"
    },
    eventSources: [
    {
      url: "/api/events", // 通常の予定
    },
    {
      url: "/api/holidays", // 祝日背景
      display: "background",
      color: "#ffecec", // 薄い赤
      overlap: false
    }
    ],

    dayCellClassNames: function(arg) {
      const day = arg.date.getDay();
      if (day === 0) return ["sunday"];   // 日曜
      if (day === 6) return ["saturday"]; // 土曜
      return [];
    },

    eventClick: function(info) {
      const event = info.event;
      document.getElementById("eventId").value = event.id;
      document.getElementById("eventTitle").value = event.title;
      document.getElementById("eventStart").value = event.start.toISOString().slice(0, 16);
      document.getElementById("eventEnd").value = event.end ? event.end.toISOString().slice(0, 16) : "";
      const modal = new bootstrap.Modal(document.getElementById("eventModal"));
      modal.show();
    },

    dateClick: function(info) {
      document.getElementById("eventTitle").value = "";
      document.getElementById("eventStart").value = info.dateStr + "T09:00";
      document.getElementById("eventEnd").value = info.dateStr + "T10:00";
      document.getElementById("eventId").value = "";
      const modal = new bootstrap.Modal(document.getElementById("eventModal"));
      modal.show();
    }
  });

  calendar.render();

   // 勤務ボタンクリックの処理（時間もセット）
document.querySelectorAll("#shiftButtons button").forEach(button => {
  button.addEventListener("click", function () {
    const shift = this.getAttribute("data-shift");
    document.getElementById("eventTitle").value = shift;

    const startInput = document.getElementById("eventStart");
    const endInput = document.getElementById("eventEnd");
    const dateStr = startInput.value.slice(0, 10); // "YYYY-MM-DD"

    if (shift === "日勤") {
      startInput.value = dateStr + "T08:00";
      endInput.value = dateStr + "T17:00";
    } else if (shift === "夜勤") {
      startInput.value = dateStr + "T16:00";
      endInput.value = dateStr + "T23:59"; // 同じ日で見た目だけ夜勤
    } else if (shift === "当直") {
      startInput.value = dateStr + "T22:00";
      endInput.value = dateStr + "T23:59"; // 同じ日で見た目だけ当直
    }
  });
});


  // モード切り替え用フラグ
  let isShiftMode = false;

  // モード切り替えボタンの処理
  document.getElementById("modeSchedule").addEventListener("click", () => {
    isShiftMode = false;
    document.getElementById("shiftButtons").style.display = "none";
    document.getElementById("eventTitle").readOnly = false;
  });

  document.getElementById("modeShift").addEventListener("click", () => {
    isShiftMode = true;
    document.getElementById("shiftButtons").style.display = "flex";
    document.getElementById("eventTitle").readOnly = true;
  });

document.getElementById("saveEvent").addEventListener("click", function () {
  const id = document.getElementById("eventId").value;
  const title = document.getElementById("eventTitle").value;
  const start = document.getElementById("eventStart").value;
  const end = document.getElementById("eventEnd").value;

  console.log("保存クリック:", { id, title, start, end });

  if (title && start && end) {
    const url = id ? "/api/update_event" : "/api/add_event";

    const allDay = isShiftMode; // シフトモードなら true、予定モードなら false

    fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, title, start, end, allDay })
    })
    .then(response => response.json())
    .then(data => {
      console.log("保存成功:", data);
      calendar.setOption("events", "/api/events?" + new Date().getTime());
      calendar.refetchEvents();

      if (isShiftMode) {
        const currentStart = new Date(start);
        const nextDate = new Date(currentStart);
        nextDate.setDate(currentStart.getDate() + 1);
        const nextDateStr = nextDate.toISOString().slice(0, 10);

        if (title === "日勤") {
          document.getElementById("eventStart").value = nextDateStr + "T08:00";
          document.getElementById("eventEnd").value = nextDateStr + "T17:00";
        } else if (title === "夜勤") {
          document.getElementById("eventStart").value = nextDateStr + "T17:00";
          document.getElementById("eventEnd").value = nextDateStr + "T23:59"; 
        } else if (title === "当直") {
            document.getElementById("eventStart").value = nextDateStr + "T22:00";
            document.getElementById("eventEnd").value = nextDateStr + "T23:59"; 
        }

        document.getElementById("eventId").value = "";
      } else {
        const modal = bootstrap.Modal.getInstance(document.getElementById("eventModal"));
        modal.hide();
      }

    })
  }
});


    document.getElementById("deleteEvent").addEventListener("click", function () {
      const id = document.getElementById("eventId").value;
      console.log("削除対象クリック:", id);

      if (id) {
        fetch("/api/delete_event", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        })
        .then(response => response.json())
        .then(data => {
          console.log("削除成功:", data); // デバッグ用
          calendar.setOption("events", "/api/events?" + new Date().getTime()); //キャッシュ回避
          calendar.refetchEvents();
          const modal = bootstrap.Modal.getInstance(document.getElementById("eventModal"));
          modal.hide();
        })
        .catch(error => {
          console.error("削除エラー:", error);
          alert("削除に失敗しました。サーバー側のURLやIDを確認してください。");
        });
      } else {
        alert("削除対象のIDがありません。");
      }
    });
});
</script>
</body>
</html>