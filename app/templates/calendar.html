<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カレンダー</title>
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

  <!-- Bootstrapは、HTML・CSS・JavaScriptで構成されたフレームワーク -->
  <!-- Bootstrap 見た目を整えるCSS-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap モーダルなどを動かすJS（モーダルは、画面全体に重ねて表示されるポップアップウィンドウ）-->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
  body {
    color: black;
  }
  #calendar {
    color: black;
  }

  /* カレンダーのヘッダー */
  .fc-toolbar-title {
    color: black !important;
  }

  /* 曜日 */
  .fc-col-header-cell-cushion {
    color: black !important;
  }

  /* 日付 */
  .fc-daygrid-day-number {
    color: black !important;
  }

  .fc-event.normal-event,.fc-event.normal-event .fc-event-title,
.fc-event.normal-event .fc-event-time {
  background-color: #fff;
  border-color: black;
  color: #000;
}

.fc-event:not(.fc-bg-event):hover {
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  border: 1px solid #666;
}

  /* 日曜の背景色 */
  .fc-day.sunday,.fc-day.holiday {
  background-color: #ffecec;
  }

  /* 土曜の背景色 */
  .fc-day.saturday {
  background-color: #e6f0ff;
  }

  .fc-timegrid-event.shift-day {
  background-color: #4DB6AC !important;
  color: #FFFFFF !important;
}
.fc-timegrid-event.shift-night {
  background-color: #1E88E5 !important;
  color: #FFFFFF !important;
}
.fc-timegrid-event.shift-duty {
  background-color: #E57373 !important;
  color: #FFFFFF !important;
}

 /* シフト共通：背景色と文字色 */
.fc-event.shift-day,.fc-event.shift-day .fc-event-title,
.fc-event.shift-day .fc-event-time {
  background-color: #4db6a4;
  color: #FFFFFF !important;
  border-radius: 4px;
  font-weight: bold;
}

.fc-event.shift-night,.fc-event.shift-night .fc-event-title,
.fc-event.shift-night .fc-event-time {
  background-color: #1E88E5;
  color: #FFFFFF !important;
  border-radius: 4px;
  font-weight: bold;
}

.fc-event.shift-duty,.fc-event.shift-duty .fc-event-title,
.fc-event.shift-duty .fc-event-time {
  background-color: #e57373;
  color: #FFFFFF !important;
  border-radius: 4px;
  font-weight: bold;
}

/* 選択日を目立たせる */
#selectedDateLabel {
  font-size: 1.1em;
  background-color: #f0f0f0;
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 10px;
}

#shiftButtons button {
  margin: 0 8px;
  padding: 10px 20px;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

/* 日勤ボタン */
#shiftButtons button[data-shift="日勤"] {
  background-color: #C5E1A5;
  color: #33691E;
}

/* 夜勤ボタン  */
#shiftButtons button[data-shift="夜勤"] {
  background-color: #81D4FA;
  color: #01579B;
}

/* 当直ボタン */
#shiftButtons button[data-shift="当直"] {
  background-color: #FFCDD2;
  color: #B71C1C;
}

/* ホバー */
.fc-event:hover {
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  border: 1px solid #666;
}

/* 日付セル */
.selected-date {
  outline: 2px solid #42a5f5;
  background-color: #e3f2fd;
  border-radius: 4px;
}
</style>

</head>
<body>
  <div id='calendar'></div>

<!-- Flask-WTFを使い、テンプレートに {{ form.xxx }} を埋め込む方法でもいい -->
<!-- モーダルフォーム（予定入力用） -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- モーダルのヘッダー -->
      <div class="modal-header">
        <h5 class="modal-title" id="eventModalLabel">予定を登録</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
      </div>


      <!-- モーダルの本文（フォーム） -->
      <div class="modal-body">
        <form id="eventForm">
          <input type="hidden" id="eventId">

          <!-- モード切り替えタブ -->
          <div class="btn-group w-100 mb-3" role="group">
            <button type="button" class="btn btn-outline-primary active" id="modeSchedule">予定登録</button>
            <button type="button" class="btn btn-outline-success" id="modeShift">シフト登録</button>
          </div>


          <!-- 選択日表示（シフト登録モードで表示） -->
          <div id="selectedDateLabel" class="mb-3" style="display:none;">
            <strong>選択日：</strong> <span id="selectedDateText"></span>
          </div>

          <div id="shiftButtons" style="display: none;">
            <button data-shift="日勤">日勤</button>
            <button data-shift="夜勤">夜勤</button>
            <button data-shift="当直">当直</button>
          </div>

          <!-- タイトルと時間入力（シフト登録モードで表示） -->
         <div class="mb-3">
           <label for="eventTitle" class="form-label">タイトル</label>
           <input type="text" class="form-control" id="eventTitle" name="eventTitle" required>
          </div>
          <div class="mb-3">
           <label for="eventStart" class="form-label">開始時間</label>
           <input type="datetime-local" class="form-control" id="eventStart" name="eventStart" required>
         </div>
          <div class="mb-3">
           <label for="eventEnd" class="form-label">終了時間</label>
            <input type="datetime-local" class="form-control" id="eventEnd" name="eventEnd" required>
          </div>
          <div class="mb-3">
            <label for="eventNote" class="form-label">メモ</label>
            <textarea class="form-control" id="eventNote" rows="2" placeholder="場所・持ち物・補足など自由に記入"></textarea>
          </div>
          <div class="mb-3">
            <label for="eventColor" class="form-label">表示色</label>
            <input type="color" class="form-control form-control-color" id="eventColor" value="#66bb6a">
          </div>
          
      <!-- モーダルのフッター（ボタン） -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-danger" id="deleteEvent">削除</button>
        <button type="button" class="btn btn-primary" id="saveEvent">保存</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  let selectedCell = null;
  let isShiftMode = false;

  const calendarEl = document.getElementById("calendar");
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    locale: "ja",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,timeGridWeek,timeGridDay"
    },
    eventSources: [
      { url: "/api/events" },
      { url: "/api/holidays" }
    ],
    eventClassNames: arg => arg.event.classNames,
    dayCellClassNames: arg => {
      const day = arg.date.getDay();
      return day === 0 ? ["sunday"] : day === 6 ? ["saturday"] : [];
    },
    eventClick: info => {
      const event = info.event;
      document.getElementById("eventId").value = event.id;
      document.getElementById("eventTitle").value = event.title;
      document.getElementById("eventStart").value = event.start.toISOString().slice(0, 16);
      document.getElementById("eventEnd").value = event.end ? event.end.toISOString().slice(0, 16) : "";
      document.getElementById("eventNote").value = event.extendedProps.note || "";
      bootstrap.Modal.getOrCreateInstance(document.getElementById("eventModal")).show();
    },
    dateClick: info => {
      if (selectedCell) selectedCell.classList.remove("selected-date");
      selectedCell = info.dayEl;
      selectedCell.classList.add("selected-date");

      const dateStr = info.dateStr;
      document.getElementById("eventTitle").value = "";
      document.getElementById("eventStart").value = dateStr + "T09:00";
      document.getElementById("eventEnd").value = dateStr + "T10:00";
      document.getElementById("eventId").value = "";
      document.getElementById("eventNote").value = "";
      document.getElementById("selectedDateText").textContent = dateStr;
      document.getElementById("modeShift").click();
      bootstrap.Modal.getOrCreateInstance(document.getElementById("eventModal")).show();
    },
    eventDidMount: info => {
      const note = info.event.extendedProps.note || "";
      const start = info.event.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const end = info.event.end ? info.event.end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "";
      info.el.setAttribute("title", `${info.event.title}\n${start}〜${end}\n${note}`);
    }
  });

  calendar.render();

  // モード切り替え
  const modeScheduleBtn = document.getElementById("modeSchedule");
  const modeShiftBtn = document.getElementById("modeShift");
  const titleGroup = document.getElementById("eventTitle").parentElement;
  const startGroup = document.getElementById("eventStart").parentElement;
  const endGroup = document.getElementById("eventEnd").parentElement;
  const saveBtn = document.getElementById("saveEvent");
  const modalTitle = document.getElementById("eventModalLabel");
  const selectedDateLabel = document.getElementById("selectedDateLabel");
  const shiftButtons = document.getElementById("shiftButtons");
  const colorGroup = document.getElementById("eventColor").closest(".mb-3");

  const scheduleInputs = document.createElement("div");
  scheduleInputs.id = "scheduleInputs";
  titleGroup.before(scheduleInputs);
  scheduleInputs.appendChild(titleGroup);
  scheduleInputs.appendChild(startGroup);
  scheduleInputs.appendChild(endGroup);

  modeScheduleBtn.addEventListener("click", () => {
    isShiftMode = false;
    modeScheduleBtn.classList.add("active");
    modeShiftBtn.classList.remove("active");
    modalTitle.textContent = "予定を登録";
    scheduleInputs.style.display = "block";
    saveBtn.style.display = "inline-block";
    selectedDateLabel.style.display = "none";
    shiftButtons.style.display = "none";
    colorGroup.style.display = "block";
    document.getElementById("customShiftButtons").style.display = "none";
    document.getElementById("eventTitle").required = true;
  });

  modeShiftBtn.addEventListener("click", () => {
    isShiftMode = true;
    modeShiftBtn.classList.add("active");
    modeScheduleBtn.classList.remove("active");
    modalTitle.textContent = "シフトを登録";
    scheduleInputs.style.display = "none";
    saveBtn.style.display = "none";
    selectedDateLabel.style.display = "block";
    shiftButtons.style.display = "flex";
    colorGroup.style.display = "none";
    document.getElementById("customShiftButtons").style.display = "flex";
    document.getElementById("eventTitle").required = false;
  });

  // 勤務ボタン（shiftButtons）クリック処理
  document.querySelectorAll("#shiftButtons button").forEach(button => {
    button.addEventListener("click", function () {
      const shift = this.getAttribute("data-shift");
      const startInput = document.getElementById("eventStart");
      const endInput = document.getElementById("eventEnd");
      const dateStr = startInput.value.slice(0, 10);

      let start = "", end = "";
      if (shift === "日勤") {
        start = dateStr + "T08:00";
        end = dateStr + "T17:00";
      } else if (shift === "夜勤") {
        start = dateStr + "T16:00";
        end = dateStr + "T23:59";
      } else if (shift === "当直") {
        start = dateStr + "T22:00";
        end = dateStr + "T23:59";
      }

      fetch("/api/events", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: shift, start, end, allDay: false })
      }).then(response => {
        if (!response.ok) {
          alert("保存に失敗しました");
          return;
        }

        calendar.refetchEvents();

        const nextDate = new Date(dateStr);
        nextDate.setDate(nextDate.getDate() + 1);
        const nextDateStr = nextDate.toISOString().slice(0, 10);

        startInput.value = nextDateStr + "T09:00";
        endInput.value = nextDateStr + "T10:00";
        document.getElementById("eventTitle").value = "";
        document.getElementById("eventId").value = "";
        document.getElementById("selectedDateText").textContent = nextDateStr;
        document.getElementById("eventNote").value = "";
      });
    });
  });

  // 保存処理
  document.getElementById("saveEvent").addEventListener("click", function () {
    const id = document.getElementById("eventId").value;
    const title = document.getElementById("eventTitle").value;
    const start = document.getElementById("eventStart").value;
    const end = document.getElementById("eventEnd").value;
    const color = isShiftMode ? null : document.getElementById("eventColor").value;
    const note = document.getElementById("eventNote").value;

    console.log("保存クリック:", { id, title, start, end });

    if (title && start && end) {
      const url = id ? "/api/update_event" : "/api/add_event";
      const allDay = isShiftMode;

      fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, title, start, end, allDay, note, color })
      })
      .then(response => response.json())
      .then(data => {
        console.log("保存成功:", data);
        calendar.refetchEvents();

        if (isShiftMode) {
          const currentStart = new Date(start);
          const nextDate = new Date(currentStart);
          nextDate.setDate(currentStart.getDate() + 1);
          const nextDateStr = nextDate.toISOString().slice(0, 10);

          if (title === "日勤") {
            document.getElementById("eventStart").value = nextDateStr + "T08:00";
            document.getElementById("eventEnd").value = nextDateStr + "T17:00";
          } else if (title === "夜勤") {
            document.getElementById("eventStart").value = nextDateStr + "T17:00";
            document.getElementById("eventEnd").value = nextDateStr + "T23:59";
          } else if (title === "当直") {
            document.getElementById("eventStart").value = nextDateStr + "T22:00";
            document.getElementById("eventEnd").value = nextDateStr + "T23:59";
          }

          document.getElementById("eventId").value = "";
        } else {
          const modal = bootstrap.Modal.getInstance(document.getElementById("eventModal"));
          modal.hide();
        }
      });
    }
  });

    document.getElementById("deleteEvent").addEventListener("click", function () {
      const id = document.getElementById("eventId").value;
      console.log("削除対象クリック:", id);

      if (id) {
        fetch("/api/delete_event", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        })
        .then(response => response.json())
        .then(data => {
          console.log("削除成功:", data); // デバッグ用
          calendar.setOption("events", "/api/events?" + new Date().getTime()); //キャッシュ回避
          calendar.refetchEvents();
          const modal = bootstrap.Modal.getInstance(document.getElementById("eventModal"));
          modal.hide();
        })
        .catch(error => {
          console.error("削除エラー:", error);
          alert("削除に失敗しました。サーバー側のURLやIDを確認してください。");
        });
      } else {
        alert("削除対象のIDがありません。");
      }
  });
});
</script>
</body>
</html>